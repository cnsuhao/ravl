dnl This file is part of QMake, Quick Make System
dnl Copyright (C) 2011-16, University of Surrey
dnl This code may be redistributed under the terms of the GNU General
dnl Public License (GPL). See the gpl.licence file for details or
dnl see http://www.gnu.org/copyleft/gpl.html
dnl
dnl file-header-ends-here



dnl QM_RESOURCE_CC_SWITCHES
dnl
dnl Macro to define and process the command-line switches associated with a
dnl particular external RESOURCE that requires a compilation-check to see if
dnl it is available.
dnl
dnl This macro declares the --with-<lib>-library and --with-<lib>-include
dnl command-line switches (and their help text). These two switches declare
dnl where the relevant support files from the external library reside (the
dnl library and header files respectivly). The --with-<lib>-include setting
dnl must point to a directory while the --with-<lib>-library setting may just
dnl be the library's name (minus an extension, with or without the lib prefix);
dnl a path to the containing directory; or both in the form 'path/name'. This
dnl method of library path specification also applies to --with-<lib> which
dnl can be used to conveniently set the path for both the --with-<lib>-library
dnl and --with-<lib>-include switches should the library and header files
dnl reside in the same directory.
dnl
dnl This macro does not create or process the --with-<lib>-pkgconf or the
dnl --with-<lib> command-line switches associated with the RESOURCE. For
dnl these, please use the QM_RESOURCE_BASIC_SWITCHES macro.
dnl
dnl Macro parameters are:
dnl       p1: QMake name for library. This is used for naming the cmd-line
dnl           switch (LIB => --with-LIB, --with-LIB-include, etc.). It
dnl           should be the name QMake expects the RESOURCES string to take
dnl           to enable the library's functionality in the client project. It
dnl           will also be the name used for the LIB_CFLAGS and LIB_LIBS used
dnl           in the relevant .def file and Config.Project
dnl       p2: Name(s) of the library as specified on the link line i.e. in
dnl           -lXXXX -lYYYY form. For library packages that vary the names
dnl           of the libraries required, this may be a set of alternative
dnl           lists seperated by a pipe symbol (|).
dnl
dnl Global variables used:
dnl
dnl   All variables listed with a <lib> in their name are created with the
dnl   <lib> being replaced by the QMake name of the package (the name passed
dnl   into this macro as the first parameter). For example,the OpenCV package
dnl   will have variables named use_OpenCV; with_OpenCV; etc.
dnl
dnl       EXPR                       Standard substitution variable pointing
dnl                                  to the UNIX expr command.
dnl       SED                        Standard substitution variable pointing
dnl                                  to the UNIX sed command.
dnl       fallback_file              This variable holds any file component
dnl                                  supplied via the --with-<lib> switch for
dnl                                  possible use, if required, to provide
dnl                                  a fallback library name if none is
dnl                                  specified by the --with-<lib>-library
dnl                                  switch.
dnl       fallback_path              This variable holds any directory path
dnl                                  component supplied via the --with-<lib>
dnl                                  switch for possible use if required to
dnl                                  provide a commond directory location for
dnl                                  both the --with-<lib>-include and the
dnl                                  --with-<lib>-library command-line options
dnl       use_<lib>                  Flag specifying useage of library,
dnl                                  primed initially by --with-<lib> or
dnl                                  as part of a dependancy check.
dnl       with_<lib>_check           Flag specifying the type of test needed
dnl                                  to check for the existance of the
dnl                                  external library:
dnl                                    bespoke      - test for the external
dnl                                                   library has been written
dnl                                                   in bespoke code located
dnl                                                   within the appropriate
dnl                                                   section of the macro
dnl                                                   QM_CK_BESPOKE_CK_LIB.
dnl                                    compile      - test for the external
dnl                                                   library involves a test
dnl                                                   compilation to see if
dnl                                                   the library is available.
dnl                                    pkgconfig    - test for the external
dnl                                                   library using pkg-config.
dnl                                    virtual      - external library is a
dnl                                                   virtual set of libraries
dnl                                                   that is implicitly
dnl                                                   available if all of the
dnl                                                   precursor libraries are
dnl                                                   available.
dnl                                  For any test-type, if the user provides
dnl                                  a --with-<lib>-pkgconf setting, this will
dnl                                  automatically force the test-type to be
dnl                                  pkgconfig.
dnl       with_<lib>_inc             Path to the library's headers
dnl       with_<lib>_include         Value of similarly named cmd-line switch
dnl                                  Specifies where the header files for the
dnl                                  library reside.
dnl       with_<lib>_libpath         Path to the location of the library
dnl       with_<lib>_lnklibs         List of the library files (in -lXXXX
dnl                                  form) needed to compile with library
dnl                                  package <lib>. For library packages that
dnl                                  vary the names of the libraries required,
dnl                                  this may be a set of alternative lists
dnl                                  seperated by a pipe symbol (|). As an
dnl                                  example, the Socket package offers the
dnl                                  setting " | -lsocket | -lsocket -lnsl "
dnl                                  as the socket() function may be available
dnl                                  in the default libraries (no additional
dnl                                  library is required - hence the leading
dnl                                  " | " setting, i.e. a null list); in the
dnl                                  socket library itself; or the socket
dnl                                  library may also depend on libnsl.
dnl       with_<lib>_library         Value of similarly named cmd-line switch
dnl                                  Specifies where the library file of the
dnl                                  library resides. Can be used to alter
dnl                                  the name of the library to be used.
dnl       with_<lib>_pkgconf         Value of similarly named cmd-line switch
dnl                                  Specifies what name pkg-config will know
dnl                                  the library as.
dnl
dnl   The following are all intermediate variables used in processing the
dnl   command-line options:
dnl
dnl       file; fallback_match; lib; part; path
dnl
AC_DEFUN([QM_RESOURCE_CC_SWITCHES],
         [
          AC_ARG_WITH([$1-library],
                      [AS_HELP_STRING([--with-$1-library],
                                      [Declare the location of the $1 library and enable its functionality]
                                     )
                      ],
                      [case "$with_$1_library" in
                          'n' | 'N' | 'no' | 'No' | 'NO' )
                                 trace 4 --with-$1-library disabling $1 libraries
                                 if ( test X$use_$1 = Xyes )
                                 then
                                    if ( test X$with_$1_check = Xpkgconfig )
                                    then
                                       # Either --with-<lib>-pkgconf is in use
                                       # or --with-<lib> specifies a .pc file
                                       AC_MSG_FAILURE([Asking to disable $1 via --with-$1-library but another configuration option has specifically asked to use pkg-config])
                                    else
                                       AC_MSG_FAILURE([Asking to disable $1 via --with-$1-library but --with-$1 has specifically enabled it])
                                    fi
                                 else
                                    if ( test X$use_$1 = Xcheck )
                                    then
                                       # Can only be here if --with-<lib>
                                       # is set to check
                                       AC_MSG_WARN([Disabling $1 via --with-$1-library despite --with-$1 having asked to check for it])
                                    fi
                                 fi
                                 use_$1=no
                                 with_$1_library=no
                                 ;;
                          'y' |'Y' | 'yes' | 'Yes' | 'YES' )
                                 if ( test X$use_$1 = Xyes )
                                 then
                                    if ( test X$with_$1_check = Xpkgconfig )
                                    then
                                       # Either --with-<lib>-pkgconf is in use
                                       # or --with-<lib> specifies a .pc file
                                       AC_MSG_FAILURE([Asking to enable $1 via --with-$1-library but another configuration option  has specifically asked to use pkg-config])
                                    fi
                                 else
                                    if ( test X$use_$1 = Xno )
                                    then
                                       if ( test X$with_$1_pkgconf = Xno )
                                       then
                                          AC_MSG_FAILURE([Asking to enable $1 via --with-$1-library but --with-$1-pkgconf has specifically disabled it])
                                       else
                                          AC_MSG_FAILURE([Asking to enable $1 via --with-$1-library but --with-$1 has specifically disabled it])
                                       fi
                                    else
                                       if ( test X$use_$1 = Xcheck )
                                       then
                                          # Can only be here if --with-<lib>
                                          # is set to check
                                          AC_MSG_WARN([Enabling $1 via --with-$1-library despite --with-$1 having asked to check for it])
                                       fi
                                    fi
                                 fi
                                 use_$1=yes
                                 with_$1_library=yes
                                 ;;
                          'c' | 'C' | 'ck'| 'Ck' | 'CK' | 'check' | 'Check' | 'CHECK' )
                                 if ( test X$use_$1 = Xyes )
                                 then
                                    if ( test X$with_$1_check = Xpkgconfig )
                                    then
                                       # Either --with-<lib>-pkgconf is in use
                                       # or --with-<lib> specifies a .pc file
                                       AC_MSG_FAILURE([Asking to check for $1 via --with-$1-library but another configuration option has specifically asked to use pkg-config])
                                    else
                                       AC_MSG_WARN([Asking to check for $1 via --with-$1-library but --with-$1 has specifically enabled it])
                                    fi
                                 else
                                    if ( test X$use_$1 = Xno )
                                    then
                                       if ( test X$with_$1_pkgconf = Xno )
                                       then
                                          AC_MSG_WARN([Asking to check for $1 via --with-$1-library but --with-$1-pkgconf has specifically disabled it])
                                       else
                                          AC_MSG_WARN([Asking to check for $1 via --with-$1-library but --with-$1 has specifically disabled it])
                                       fi
                                    else
                                       if ( test X$use_$1 = Xcheck )
                                       then
                                          # Can only be here if --with-<lib>
                                          # is set to check (which probvides
                                          # no conflict).
                                          with_$1_library=check
                                       else
                                          # No user setting from with-<lib>
                                          # or --with-<lib>-pkgconf
                                          use_$1=check
                                          # This is the only condition where
                                          # we need to be updating use_<lib>
                                       fi
                                    fi
                                 fi
                                 with_$1_library=check
                                 ;;
                          * )
                                 if ( test X$use_$1 = Xyes )
                                 then
                                    if ( test X$with_$1_check = Xpkgconfig )
                                    then
                                       # Either --with-<lib>-pkgconf is in use
                                       # or --with-<lib> specifies a .pc file
                                       AC_MSG_FAILURE([Asking to link with a specific library via --with-$1-library but another configuration option has specifically asked to use pkg-config])
                                    fi
                                 else
                                    if ( test X$use_$1 = Xno )
                                    then
                                       if ( test X$with_$1_pkgconf = Xno )
                                       then
                                          AC_MSG_FAILURE([Asking to link with a specific library via --with-$1-library but --with-$1-pkgconf has specifically disabled the package])
                                       else
                                          AC_MSG_FAILURE([Asking to link with a specific library via --with-$1-library but --with-$1 has specifically disabled the package])
                                       fi
                                    else
                                       if ( test X$use_$1 = Xcheck )
                                       then
                                          # Can only be here if --with-<lib>
                                          # is set to check
                                          AC_MSG_WARN([Asking to link with a specific library via --with-$1-library despite --with-$1 having asked to check for the package])
                                       fi
                                    fi
                                 fi
                                 use_$1=yes
                                 ;;
                       esac
                      ],
                      [trace 4 No --with-$1-library specified
                       with_$1_library=notset
                      ]
                     )

          AC_ARG_WITH([$1-include],
                      [AS_HELP_STRING([--with-$1-include],
                                      [Declare the location of the $1 header files and enable their functionality]
                                     )
                      ],
                      [case "$with_$1_include" in
                          'n' | 'N' | 'no' | 'No' | 'NO' )
                                 trace 4 --with-$1-include disabling $1 libraries
                                 if ( test X$use_$1 = Xyes )
                                 then
                                    if ( test X$with_$1_check = Xpkgconfig )
                                    then
                                       # Either --with-<lib>-pkgconf is in use
                                       # or --with-<lib> specifies a .pc file
                                       AC_MSG_FAILURE([Asking to disable $1 via --with-$1-include but another configuration option has specifically asked to use pkg-config])
                                    else
                                       # As use_<lib>=yes, the only possible
                                       # values for --with-<lib>-library are:
                                       # notset; yes; check or a path. So, we
                                       # can check for the conflicting setting
                                       # of yes or any path by determining the
                                       # setting is not check or notset.
                                       if ( test X$with_$1_library != Xnotset && test X$with_$1_library != Xcheck )
                                       then
                                          AC_MSG_FAILURE([Asking to disable $1 via --with-$1-include but --with-$1-library has specifically enabled it])
                                       else
                                          AC_MSG_FAILURE([Asking to disable $1 via --with-$1-include but --with-$1 has specifically enabled it])
                                       fi
                                    fi
                                 else
                                    if ( test X$use_$1 = Xcheck )
                                    then
                                       # Can never be here because of
                                       # --with-<lib>-pkgconf
                                       if ( test X$with_$1_library = Xcheck )
                                       then
                                          AC_MSG_WARN([Disabling $1 via --with-$1-include despite --with-$1-library having asked to check for it])
                                       else
                                          AC_MSG_WARN([Disabling $1 via --with-$1-include despite --with-$1 having asked to check for it])
                                       fi
                                    fi
                                 fi
                                 use_$1=no
                                 with_$1_include=no
                                 ;;
                          'y' |'Y' | 'yes' | 'Yes' | 'YES' )
                                 if ( test X$use_$1 = Xyes )
                                 then
                                    if ( test X$with_$1_check = Xpkgconfig )
                                    then
                                       # Either --with-<lib>-pkgconf is in use
                                       # or --with-<lib> specifies a .pc file
                                       AC_MSG_FAILURE([Asking to enable $1 via --with-$1-include but another configuration option  has specifically asked to use pkg-config])
                                    fi
                                 else
                                    if ( test X$use_$1 = Xno )
                                    then
                                       if ( test X$with_$1_pkgconf = Xno )
                                       then
                                          AC_MSG_FAILURE([Asking to enable $1 via --with-$1-include but --with-$1-pkgconf has specifically disabled it])
                                       else
                                          if ( test X$with_$1_library = Xno )
                                          then
                                             AC_MSG_FAILURE([Asking to enable $1 via --with-$1-include but --with-$1-library has specifically disabled it])
                                          else
                                             AC_MSG_FAILURE([Asking to enable $1 via --with-$1-include but --with-$1 has specifically disabled it])
                                          fi
                                       fi
                                    else
                                       if ( test X$use_$1 = Xcheck )
                                       then
                                          # Can never be here because of
                                          # --with-<lib>-pkgconf
                                          if ( test X$with_$1_library = Xcheck )
                                          then
                                             AC_MSG_WARN([Enabling $1 via --with-$1-include despite --with-$1-library having asked to check for it])
                                          else
                                             AC_MSG_WARN([Enabling $1 via --with-$1-include despite --with-$1 having asked to check for it])
                                          fi
                                       fi
                                    fi
                                 fi
                                 use_$1=yes
                                 with_$1_include=yes
                                 ;;
                          'c' | 'C' | 'ck'| 'Ck' | 'CK' | 'check' | 'Check' | 'CHECK' )
                                 if ( test X$use_$1 = Xyes )
                                 then
                                    if ( test X$with_$1_check = Xpkgconfig )
                                    then
                                       # Either --with-<lib>-pkgconf is in use
                                       # or --with-<lib> specifies a .pc file
                                       AC_MSG_FAILURE([Asking to check for $1 via --with-$1-include but another configuration option has specifically asked to use pkg-config])
                                    else
                                       # As use_<lib>=yes, the only possible
                                       # values for --with-<lib>-library are:
                                       # notset; yes; check or a path. So, we
                                       # can check for the conflicting setting
                                       # of yes or any path by determining the
                                       # setting is not check or notset.
                                       if ( test X$with_$1_library != Xcheck && test X$with_$1_library != Xnotset )
                                       then
                                          AC_MSG_WARN([Asking to check for $1 via --with-$1-include but --with-$1-library has specifically enabled it])
                                       else
                                          AC_MSG_WARN([Asking to check for $1 via --with-$1-include but --with-$1 has specifically enabled it])
                                       fi
                                    fi
                                 else
                                    if ( test X$use_$1 = Xno )
                                    then
                                       if ( test X$with_$1_pkgconf = Xno )
                                       then
                                          AC_MSG_WARN([Asking to check for $1 via --with-$1-include but --with-$1-pkgconf has specifically disabled it])
                                       else
                                          if ( test X$with_$1_library = Xno )
                                          then
                                             AC_MSG_WARN([Asking to check for $1 via --with-$1-include but --with-$1-library has specifically disabled it])
                                          else
                                             AC_MSG_WARN([Asking to check for $1 via --with-$1-include but --with-$1 has specifically disabled it])
                                          fi
                                       fi
                                    else
                                       if ( test X$use_$1 = Xcheck )
                                       then
                                          # Can never be here because of
                                          # --with-<lib>-pkgconf so we do not
                                          # need to check for any incompatable
                                          # settings
                                          with_$1_include=check
                                       else
                                          # No other user setting
                                          use_$1=check
                                          # This is the only condition where
                                          # we need to be updating use_<lib>
                                       fi
                                    fi
                                 fi
                                 with_$1_include=check
                                 ;;
                          * )
                                 if ( test X$use_$1 = Xyes )
                                 then
                                    if ( test X$with_$1_check = Xpkgconfig )
                                    then
                                       # Either --with-<lib>-pkgconf is in use
                                       # or --with-<lib> specifies a .pc file
                                       AC_MSG_FAILURE([Asking to use specific header files for $1 via --with-$1-include but another configuration option has specifically asked to use pkg-config])
                                    fi
                                 else
                                    if ( test X$use_$1 = Xno )
                                    then
                                       if ( test X$with_$1_pkgconf = Xno )
                                       then
                                          AC_MSG_FAILURE([Asking to use specific header files for $1 via --with-$1-include but --with-$1-pkgconf has specifically disabled the package])
                                       else
                                          if ( test X$with_$1_library = Xno )
                                          then
                                             AC_MSG_FAILURE([Asking to use specific header files for $1 via --with-$1-include but --with-$1-library has specifically disabled the package])
                                          else
                                             AC_MSG_FAILURE([Asking to use specific header files for $1 via --with-$1-include but --with-$1 has specifically disabled the package])
                                          fi
                                       fi
                                    else
                                       if ( test X$use_$1 = Xcheck )
                                       then
                                          # Can never be here because of
                                          # --with-<lib>-pkgconf
                                          if ( test X$with_$1_library = Xcheck )
                                          then
                                             AC_MSG_WARN([Asking to use specific header files for $1 via --with-$1-include despite --with-$1-library having asked to check for the package])
                                          else
                                             AC_MSG_WARN([Asking to use specific header files for $1 via --with-$1-include despite --with-$1 having asked to check for the package])
                                          fi
                                       fi
                                    fi
                                 fi
                                 use_$1=yes
                                 ;;
                       esac
                      ],
                      [trace 4 No --with-$1-include specified
                       with_$1_include=notset
                      ]
                     )

          if ( test X$use_$1 != Xno )
          then
             # Package is not disabled, need to determine what to test with

             if ( test "X$with_$1_check" != "Xpkgconfig" )
             then
                # Not using pkg-config, set any paths for compile checks

                # Check if --with-$1-library is a specification rather than a
                # simple switch
                if ( test "$with_$1_library" != notset && test "$with_$1_library" != no && test "$with_$1_library" != check && test "$with_$1_library" != yes )
                then
                   # We have a path specification to parse
                   #
                   # If the specification is a straight forward link line (of
                   # the form "-L/a/b/c -ld .. -L/w/x/y -lz" we want to split
                   # off the last -l entries into with_$1_lnklibs and include
                   # the initial part of the link line in with_$1_libpath.
                   # If we just have directory and library paths, we need to
                   # add the relevant linker switch, and assign the parameter
                   # to the appropriate variable.
                   #
                   with_$1_lnklibs=""
                   with_$1_libpath=""
                   use_$1=yes
                   trace 6 Parsing --with-$1-library setting
                   with_$1_library=`echo " $with_$1_library " | $SED 's/ -L */ -L/g;s/ -l */ -l/g'`
                   # Collapse down spaces following -L and -l entries. This is
                   # mainly for ease of parsing but does make any user input
                   # compatible with the form of the default values used
                   # throughout this configure script. Downsides are that any
                   # other -X <arg> switches provided by the user will not
                   # parse correctly and a general issue awaiting any systems
                   # that must have the space between the switch and its
                   # argument. The latter issue is the bigger problem as such
                   # a limitation will have big consequences for this script
                   # if we ever hit such a constrained toolset.
                   for part in $with_$1_library
                   do
                      case $part in
                      -L* )   # Library path specifier. Any previous library
                              # names ought to be recorded as part of libpath
                              # to maintain any order significance of the
                              # supplied link command.
                              TRACE_INDENT="     "
                              trace 6 Appending @<:@$part@:>@ to library path
                              with_$1_libpath="$with_$1_libpath$with_$1_lnklibs$part "
                              with_$1_lnklibs=""
                              ;;
                      -l* )   # Library specifier. Append to the linklib
                              # variable.
                              TRACE_INDENT="     "
                              trace 6 Appending @<:@$part@:>@ to library list
                              with_$1_lnklibs="$with_$1_lnklibs$part "
                              ;;
                      -* )    # Presume linker switch. Append to libpath after
                              # adding any existing library specs (so as to
                              # maintain any order specific requirements).
                              TRACE_INDENT="     "
                              trace 6 Appending @<:@$part@:>@ to link line
                              with_$1_libpath="$with_$1_libpath$with_$1_lnklibs$part "
                              with_$1_lnklibs=""
                              ;;
                      * )     # Non-linker format, see if we can work out
                              # what it is
                              if ( test -d $part )
                              then
                                 # We have a directory, add to libpath with
                                 # a -L prefix having moved across any
                                 # libraries from lnklibs to preserve ordering
                                 # constraints
                                 TRACE_INDENT="     "
                                 trace 6 Adding @<:@-L$part@:>@ to link line
                                 with_$1_libpath="$with_$1_libpath${with_$1_lnklibs}-L$part "
                                 with_$1_lnklibs=""
                              else
                                 # Not a directory, is it directory/file?
                                 path=`AS_DIRNAME([$part])`
                                 if ( test X$path != X && test $path != . )
                                 then
                                    # We have "something/file" does the
                                    # "something" point to a directory?
                                    if ( test -d $path  )
                                    then
                                       # We have "directory/presumed-library-name"
                                       # Find candidate library name
                                       file=`$EXPR "//$part" : '.*/\(@<:@^/@:>@*\)'`
                                       if ( test $part = $path/$file )
                                       then
                                          # Parameter is a file path
                                          # Does it have a '.a' extension
                                          lib=`$EXPR "X$file" : 'X\(.*\)\.a$'`
                                          if ( test X$lib != X  )
                                          then
                                             lib=`echo $lib | $SED 's/^lib//'`
                                             AC_MSG_WARN([Specifying --with-$1_library pointing to a .a])
                                             AC_MSG_WARN([will cause problems building with shared libraries.])
                                             AC_MSG_WARN([Instead we will use -l$lib])
                                          else
                                             # Does it have a '.so' extension
                                             lib=`$EXPR "X$file" : 'X\(.*\)\.so$'`
                                             if ( test X$lib != X )
                                             then
                                                lib=`echo $lib | $SED 's/^lib//'`
                                                AC_MSG_WARN([Specifying --with-$1_library pointing to])
                                                AC_MSG_WARN([a .so will cause problems building with ])
                                                AC_MSG_WARN([static libraries. Instead, we will use])
                                                AC_MSG_WARN([-l$lib])
                                             else
                                                # Parameter is path and name fragment
                                                lib=`echo $file | $SED 's/^lib//'`
                                             fi
                                          fi
                                          # As the user specified the library
                                          # as a path rather than with a -L
                                          # and a -l entry, it would be good
                                          # to continue in the same vein.
                                          # However, as -l/full/path is not
                                          # supported, we have to revert to
                                          # the seperate specifiers.
                                          TRACE_INDENT="     "
                                          trace 6 Adding @<:@-L$path@:>@ to library path
                                          with_$1_libpath="$with_$1_libpath$with_$1_lnklibs-L$path "
                                          with_$1_lnklibs=""
                                          TRACE_INDENT="     "
                                          trace 6 Adding @<:@-l$lib@:>@ to library list
                                          with_$1_lnklibs="-l$lib "
                                       else
                                          # Somehow dirname($x)/basename($x) != $x
                                          AC_MSG_WARN([Problem processing --with-$1-library, @<:@$part@:>@ ignored])
                                       fi
                                    else
                                       # Parameter is "not-a-dir-path/something"
                                       AC_MSG_WARN([Illegal value for --with-$1-library, @<:@$part@:>@ ignored])
                                    fi
                                 else
                                    # Parameter is just "something" - assume library name
                                    #
                                    # Does it have a '.a' extension
                                    lib=`$EXPR "X$part" : 'X\(.*\)\.a$'`
                                    if ( test X$lib != X  )
                                    then
                                       lib=`echo $lib | $SED 's/^lib//'`
                                       AC_MSG_WARN([Specifying --with-$1_library pointing to a .a])
                                       AC_MSG_WARN([will cause problems building with shared libraries.])
                                       AC_MSG_WARN([Instead we will use -l$lib])
                                    else
                                       # Does it have a '.so' extension
                                       lib=`$EXPR "X$part" : 'X\(.*\)\.so$'`
                                       if ( test X$lib != X )
                                       then
                                          lib=`echo $lib | $SED 's/^lib//'`
                                          AC_MSG_WARN([Specifying --with-$1_library pointing to])
                                          AC_MSG_WARN([a .so will cause problems building with ])
                                          AC_MSG_WARN([static libraries. Instead, we will use])
                                          AC_MSG_WARN([-l$lib])
                                       else
                                          # Parameter is name fragment
                                          lib=`echo $part | $SED 's/^lib//'`
                                       fi
                                    fi
                                    TRACE_INDENT="     "
                                    trace 6 Adding @<:@-l$lib@:>@ to library list
                                    with_$1_lnklibs="${with_$1_lnklibs}-l$lib "
                                 fi
                              fi
                              ;;
                      esac
                   done
                   trace 3 Link line assembled from --with-$1-library is @<:@$with_$1_libpath $with_$1_lnklibs@:>@
                   # Now verify what we have
                   if ( test X`$EXPR "X $with_$1_libpath $with_$1_lnklibs" : '.* \(-l@<:@^ @:>@*\).*$'` == X )
                   then
                      # no -lxxx in libpath or lnklibs - use any fallback or the
                      # default library name
                      if ( test X$fallback_file != X )
                      then
                         # --with_$1 specified a fallback name, use that but
                         # sanitise it first
                         lib=`$EXPR "X$fallback_file" : 'X\(.*\)\.a$'`
                         if ( test X$lib != X  )
                         then
                            # Removed an unwanted .a suffix
                            # Now strip any leading -l or lib prefix
                            with_$1_lnklibs=-l`echo $lib | $SED 's/^-l//;s/^lib//'`
                            AC_MSG_WARN([Specifying --with-$1 pointing to a .a])
                            AC_MSG_WARN([will cause problems building with shared libraries.])
                            AC_MSG_WARN([Instead we will use -l$lib])
                         else
                            lib=`$EXPR "X$fallback_file" : 'X\(.*\)\.so$'`
                            if ( test X$lib != X )
                            then
                               # Removed an unwanted .so suffix
                               # Now strip any leading -l or lib prefix
                               with_$1_lnklibs=-l`echo $lib | $SED 's/^-l//;s/^lib//'`
                               AC_MSG_WARN([Specifying --with-$1 pointing to a .so])
                               AC_MSG_WARN([will cause problems building with static libraries.])
                               AC_MSG_WARN([Instead, we will use -l$lib])
                               AC_MSG_WARN([])
                            else
                               # No suffix to strip
                               # Strip any leading -l or lib prefix
                               with_$1_lnklibs=-l`echo $fallback_file | $SED 's/^-l//;s/^lib//'`
                            fi
                         fi
                         trace 3 No library name specified by --with-$1-library, using --with-$1 value @<:@$with_$1_lnklibs@:>@
                      else
                         trace 3 No library name specified by --with-$1-library, using default @<:@"$2"@:>@
                         with_$1_lnklibs="$2"
                      fi

                      if ( test X$fallback_path != X )
                      then
                         # --with_$1 specified a fallback path, are we using
                         # it?
                         if ( test X`$EXPR "X $with_$1_libpath " : '.* \(-L@<:@^ @:>@*\).*$'` == X )
                         then
                            # We do not have a library path; add the fallback
                            with_$1_libpath="-L$fallback_path $with_$1_libpath"
                            # It is an assumption to put it first, but we do
                            # not know where the relevant library is in the
                            # link specification, so we have to put it there.
                            trace 3 No path component of --with-$1-library, using --with-$1 to set library path for $1 @<:@-L$fallback_path@:>@
                         else
                            if ( test X`$EXPR "X $with_$1_libpath " : ".* \(-L$fallback_path\)/* .*"` == X )
                            then
                               AC_MSG_WARN([--with-$1-library and --with-$1 specify different paths, --with-$1 path ignored])
                            fi
                         fi
                      fi
                   else
                      # We already have a library specified, confirm that any
                      # --with_$1 setting agreed
                      if ( test X$fallback_file != X )
                      then
                         lib=`echo $fallback_file | $SED 's/^-l//;s/^lib//;s/\(.*\)\.a/\1/;s/\(.*\).so/\1/'`
                         # strip any leading -l or lib prefix; any trailing .a
                         # or .so suffixes
                         if ( test X`$EXPR "X $with_$1_libpath $with_$1_lnklibs " : ".* \(-l$lib\) .*"` == X )
                         then
                            # No -l<fallback>
                            AC_MSG_WARN([--with-$1-library and --with-$1 specify different libraries, --with-$1 library setting ignored])
                         fi
                      fi

                      if ( test X$fallback_path != X )
                      then
                         # --with_$1 specified a fallback path, are we using
                         # it?
                         if ( test X`$EXPR "X $with_$1_libpath " : '.* \(-L@<:@^ @:>@*\).*$'` == X )
                         then
                            # We do not have any library path; add the fallback
                            trace 3 No path specified by --with-$1-library, using --with-$1 value @<:@-L$fallback_path@:>@
                            with_$1_libpath="-L$fallback_path $with_$1_libpath"
                            # It is an assumption to put it first, but we do
                            # not know where the relevant library is in the
                            # link specification, so we have to put it there.
                         else
                            if ( test X`$EXPR "X $with_$1_libpath " : ".* \(-L$fallback_path\)/* .*"` == X )
                            then
                               # No -L entry for the fallback path.
                               AC_MSG_WARN([--with-$1-library and --with-$1 specify different paths, --with-$1 path ignored])
                            fi
                         fi
                      fi
                   fi
                else
                   # --with-$1-library used as a switch; employ fallback/default paths
                   if ( test X$fallback_path != X )
                   then
                      trace 3 Using path component of --with-$1 to set library path for $1 @<:@-L$fallback_path@:>@
                      with_$1_libpath=-L$fallback_path
                      use_$1=yes
                   else
                      with_$1_libpath=""
                   fi
                   if ( test X$fallback_file != X )
                   then
                         # --with_$1 specified a fallback name, use that but
                         # sanitise it first
                         lib=`$EXPR "X$fallback_file" : 'X\(.*\)\.a$'`
                         if ( test X$lib != X  )
                         then
                            # Removed an unwanted .a suffix
                            # Now strip any leading -l or lib prefix
                            with_$1_lnklibs=-l`echo $lib | $SED 's/^-l//;s/^lib//'`
                            AC_MSG_WARN([Specifying --with-$1 pointing to a .a])
                            AC_MSG_WARN([will cause problems building with shared libraries.])
                            AC_MSG_WARN([Instead we will use -l$lib])
                         else
                            lib=`$EXPR "X$fallback_file" : 'X\(.*\)\.so$'`
                            if ( test X$lib != X )
                            then
                               # Removed an unwanted .so suffix
                               # Now strip any leading -l or lib prefix
                               with_$1_lnklibs=-l`echo $lib | $SED 's/^-l//;s/^lib//'`
                               AC_MSG_WARN([Specifying --with-$1 pointing to a .so])
                               AC_MSG_WARN([will cause problems building with static libraries.])
                               AC_MSG_WARN([Instead, we will use -l$lib])
                               AC_MSG_WARN([])
                            else
                               # No suffix to strip
                               # Strip any leading -l or lib prefix
                               with_$1_lnklibs=-l`echo $fallback_file | $SED 's/^-l//;s/^lib//'`
                            fi
                         fi
                         trace 3 Using file component of --with-$1 to set library name for $1 @<:@$with_$1_lnklibs@:>@
                   else
                      trace 3 Using default library name for $1 @<:@"$2"@:>@
                      with_$1_lnklibs="$2"
                   fi
                fi


                # Check if --with-$1-include is a path parameter
                if ( test "$with_$1_include" != notset && test "$with_$1_include" != no && test "$with_$1_include" != check && test "$with_$1_include" != yes )
                then
                   # we have a parameter rather than a switch to use
                   with_$1_inc=""
                   use_$1=yes
                   if ( test X$fallback_path != X )
                   then
                      fallback_match=no
                      # If we have a fallback path, we want to check it is
                      # included in the -include setting and warn if not
                   else
                      fallback_match=yes
                      # We have no fallback, so we never need to warn the user
                   fi
                   trace 6 Parsing --with-$1-include setting
                   # Strip any provided -I entries for ease of parsing.
                   for path in `echo " $with_$1_include " | $SED 's/ -I *//g'`
                   do
                      if ( test -d $path )
                      then
                         TRACE_INDENT="     "
                         trace 6 Appending @<:@-I$path@:>@ to set include path for $1
                         with_$1_inc="$with_$1_inc-I$path "
                         if ( test $fallback_match == no && test $fallback_path == $path )
                         then
                            fallback_match=yes
                         fi
                      else
                         AC_MSG_WARN([Illegal component of --with-$1-include, @<:@$path@:>@ ignored])
                      fi
                   done
                   if ( test X$with_$1_inc == X )
                   then
                      # No path from argument, any fallback?
                      if ( test X$fallback_path != X )
                      then
                         AC_MSG_WARN([Will use --with-$1 value @<:@-I$fallback_path@:>@])
                         with_$1_inc=-I$fallback_path
                      else
                         AC_MSG_WARN([Will use default system include path])
                         with_$1_inc=""
                      fi
                   else
                      # We have valid path(es) supplied by the user, do they
                      # encompass the fallback setting?
                      if ( test $fallback_match != yes )
                      then
                         AC_MSG_WARN([--with-$1-include and --with-$1 specify different paths, --with-$1 ignored])
                      fi
                   fi
                else
                   # --with-$1-include is a switch setting rather than a path,
                   # use any available fallback
                   if ( test X$fallback_path != X )
                   then
                      trace 3 No path specified by --with-$1-include, using --with-$1 value @<:@-I$fallback_path@:>@
                      with_$1_inc=-I$fallback_path
                      use_$1=yes
                   else
                      trace 3 Will use default system include path
                      with_$1_inc=""
                   fi
                fi
             fi # End of: if ( test $with_$1_check !- pkgconfig
          else
             trace 4 Library $1 disabled
          fi
         ]
        )

