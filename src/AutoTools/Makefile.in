# @configure_input@

package = @PACKAGE_NAME@
version = @PACKAGE_VERSION@
tarname = @PACKAGE_TARNAME@
distdir = $(tarname)-$(version)

SOURCEHOME=@abs_top_srcdir@/src

INSTALLHOME=@abs_top_builddir@

WORKING_QMAKE=@abs_top_builddir@/share/QMake
#JFi:To Do - Set this from configure (to allow use of any installed QMake)

# Include QMake global definitions
include @abs_top_builddir@/QMake/Config.QMake

# Include package specific definitions
include $(INSTALLHOME)/Config.Package

# Include package specific installation targets
include $(INSTALLHOME)/Targets.Package

# RAVL Makefile and default flags for QMake and RAVL itself

RAVL_MAKEFILE=$(WORKING_QMAKE)/Makefiles/QMake.mk

RAVL_FLAGS=INSTALLHOME=$(INSTALLHOME) BASEINSTALL=1 PROJECT_OUT=$(INSTALLHOME) FULLBUILDSRC='BASE_VAR=none' CONFIGFILE=$(INSTALLHOME)/Config.Package LOCALTMP=$(INSTALLHOME) INCLUDEDIR=$(INSTALLHOME)/include

# Trace commands if QMAKE_INFO is in use
ifndef QMAKE_INFO
SHOWIT=@
else
SHOWIT=
endif

# Builds

default: qmake fullsrc opt optshared optbin singleopt singleoptshared singleoptbin singleoptsharedbin
#JFi:To Do- make doc (and support from configure i.e. locate tools)

check: testopt testsingleopt testsingleoptshared 

debug: qmake
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(RAVL_MAKEFILE) $(RAVL_FLAGS) VAR=debug NOEXEBUILD=1 libbuild

debugshared: qmake
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(RAVL_MAKEFILE) $(RAVL_FLAGS) VAR=debug SHAREDBUILD=1 NOEXEBUILD=1 libbuild

distdir: rpm

doc: qmake
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(RAVL_MAKEFILE) $(RAVL_FLAGS) fulldoc

fullsrc: qmake
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(RAVL_MAKEFILE) $(RAVL_FLAGS) NOCHECKOUT=1 fullsrc

install: installQMake installsingleoptshared installHdrs

installHdrs:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(WORKING_QMAKE)/Makefiles/Install.mk  INSTALLHOME=$(INSTALLHOME) PLIB= VAR=opt SHARED_LIB_POSTFIX=/shared/single SHAREDBUILD=1 insHdrs recurse

installoptshared:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(WORKING_QMAKE)/Makefiles/Install.mk  INSTALLHOME=$(INSTALLHOME) VAR=opt SHAREDBUILD=1 install recurse

installsingleoptshared:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(WORKING_QMAKE)/Makefiles/Install.mk  INSTALLHOME=$(INSTALLHOME) PLIB= VAR=opt SHARED_LIB_POSTFIX=/shared/single SHAREDBUILD=1 install recurse
	$(SHOWIT)if [ ! -d $(DESTDIR)$(libdir) ] ; then $(MKDIR_P) $(DESTDIR)$(libdir) ; fi
	$(INSTALL) $(INSTALLHOME)/lib/RAVL/$(ARC)/opt/shared/single/libRavl.so $(DESTDIR)$(libdir)/libRavl.so
# Use the 'install' function of QMake to install the Ravl utility binaries;
# config files; data files and scripts. We must set SHARED_LIB_POSTFIX
# (to /shared/single) in order to force QMake to use the version of the
# binaries compiled against the single shared Ravl library rather than the
# more usual (for QMake) individual shared libraries. As we do not want to
# install the individual libraries, we also force PLIB to an empty value to
# prevent this. We then manually copy across the single shared library. This
# whole process starts off in the top level source directory and the 'recurse'
# target walks down the tree using the defs.mk files to determine the files
# to install
installQMake:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -f @abs_top_builddir@/QMake/Makefile STAGING=@abs_top_builddir@/QMake install

opt: qmake
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(RAVL_MAKEFILE) $(RAVL_FLAGS) VAR=opt NOEXEBUILD=1 libbuild

optbin: qmake
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(RAVL_MAKEFILE) $(RAVL_FLAGS) fullopt

optshared: qmake
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(RAVL_MAKEFILE) $(RAVL_FLAGS) VAR=opt SHAREDBUILD=1 NOEXEBUILD=1 libbuild

qmake: @NeededQMake@
# Will equate to "LocalQMake QMake" unless we already have an installed
# QMake when only a new copy for installation (QMake) will be needed.

QMake:
	$(MAKE) -f @abs_top_builddir@/QMake/Makefile STAGING=@abs_top_builddir@/QMake
# Stage, under @abs_top_builddir@/QMake, a version of QMake ready for a
# standard install (one that will run when the makefiles are installed
# under $(datadir)/QMake/Makefiles).

LocalQMake: 
	$(MAKE) -f @abs_top_builddir@/QMake/Makefile DESTDIR=staged bindir=@abs_top_builddir@/share/QMake/bin \
                         datadir=@abs_top_builddir@/share sysconfdir=@abs_top_builddir@ STAGING=@abs_top_builddir@/share/QMake
# Stage QMake under the Ravl build directory in a form that will run from
# that directory. To achieve this, we have to set the destination for both
# the staging and install targets to be the same for the makefiles. The
# install target for the makefiles uses $(datadir)/QMake/Makefiles as its
# destination, while the staging target uses $(STAGING)/Makefiles; hence the
# slightly different values for those two variables. DESTDIR=staged prevents
# make complaining about using identical destinations for both the staged and
# install targets. As we are only staging and not performing an install,
# DESTDIR will have no other effect and gives us the functionality we are
# looking for. As well as $(datadir), $(sysconfdir) automatically has /QMake
# suffixed to it for the install process, hence the value of $(sysconfdir) 
# that is used here.

retestopt:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(RAVL_MAKEFILE) $(RAVL_FLAGS) VAR=opt TEST_TARGET=opt retest

retestsingleopt:
	@cd $(INSTALLHOME)/test/opt/single/bin; ls > ../TestExes
	cd $(INSTALLHOME)/test/opt/single && \
           PATH=$(INSTALLHOME)/test/opt/single/bin:$(INSTALLHOME)/bin/utils/opt/single/bin:$$PATH \
           $(INSTALLHOME)/bin/utils/opt/bin/Validate -v $(INSTALLHOME)/test/opt/single
	
retestoptshared:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(RAVL_MAKEFILE) $(RAVL_FLAGS) VAR=opt SHAREDBUILD=1 TEST_TARGET=optshared retest

retestsingleoptshared:
	@cd $(INSTALLHOME)/test/opt/shared/single/bin; ls > ../TestExes
	cd $(INSTALLHOME)/test/opt/shared/single && \
           PATH=$(INSTALLHOME)/test/opt/shared/single/bin:$(INSTALLHOME)/bin/utils/opt/shared/single/bin:$$PATH \
           LD_LIBRARY_PATH=$(INSTALLHOME)/lib/RAVL/$(ARC)/opt/shared/single:$$LD_LIBRARY_PATH \
           $(INSTALLHOME)/bin/utils/opt/bin/Validate -v $(INSTALLHOME)/test/opt/shared/single
	
#JFi:Only start of RPM process implemented. Should automate everything or drop.
rpm: qmake 
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(RAVL_MAKEFILE) $(RAVL_FLAGS) rpmbuild 

singleopt:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(WORKING_QMAKE)/Packages/Ravl/Makefiles/SingleLib.mk INSTALLHOME=$(INSTALLHOME) VAR=opt makedirs buildstatic

singleoptbin:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(WORKING_QMAKE)/Packages/Ravl/Makefiles/Recursive.mk INSTALLHOME=$(INSTALLHOME) VAR=opt SINGLELIB=1 programs recurse

singleoptshared:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(WORKING_QMAKE)/Packages/Ravl/Makefiles/SingleLib.mk INSTALLHOME=$(INSTALLHOME) VAR=opt SHAREDBUILD=1 makedirs buildshared

singleoptsharedbin:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(WORKING_QMAKE)/Packages/Ravl/Makefiles/Recursive.mk INSTALLHOME=$(INSTALLHOME) VAR=opt SINGLELIB=1 SHAREDBUILD=1 programs recurse

singledebug:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(WORKING_QMAKE)/Packages/Ravl/Makefiles/SingleLib.mk INSTALLHOME=$(INSTALLHOME) VAR=debug makedirs buildstatic

singledebugbin:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(WORKING_QMAKE)/Packages/Ravl/Makefiles/Recursive.mk INSTALLHOME=$(INSTALLHOME) VAR=debug SINGLELIB=1 programs recurse

singledebugshared:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(WORKING_QMAKE)/Packages/Ravl/Makefiles/SingleLib.mk INSTALLHOME=$(INSTALLHOME) VAR=debug SHAREDBUILD=1 makedirs buildshared

singledebugsharedbin:
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(WORKING_QMAKE)/Packages/Ravl/Makefiles/Recursive.mk INSTALLHOME=$(INSTALLHOME) VAR=debug SINGLELIB=1 SHAREDBUILD=1 programs recurse

testopt:
	@$(RM) -f $(INSTALLHOME)/test/opt/bin/*
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(RAVL_MAKEFILE) $(RAVL_FLAGS) VAR=opt TEST_TARGET=opt test

testsingleopt:
	@$(RM) -f $(INSTALLHOME)/test/opt/single/bin/*
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(WORKING_QMAKE)/Packages/Ravl/Makefiles/Recursive.mk INSTALLHOME=$(INSTALLHOME) VAR=opt SINGLELIB=1 test recurse
	@cd $(INSTALLHOME)/test/opt/single/bin; ls > ../TestExes
	cd $(INSTALLHOME)/test/opt/single && \
           PATH=$(INSTALLHOME)/test/opt/single/bin:$(INSTALLHOME)/bin/utils/opt/single/bin:$$PATH \
           $(INSTALLHOME)/bin/utils/opt/bin/Validate -v $(INSTALLHOME)/test/opt/single
	
testoptshared:
	@$(RM) -f $(INSTALLHOME)/test/opt/shared/bin/*
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(RAVL_MAKEFILE) $(RAVL_FLAGS) VAR=opt SHAREDBUILD=1 TEST_TARGET=optshared test

testsingleoptshared:
	@$(RM) -f $(INSTALLHOME)/test/opt/shared/single/bin/*
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(WORKING_QMAKE)/Packages/Ravl/Makefiles/Recursive.mk INSTALLHOME=$(INSTALLHOME) VAR=opt SINGLELIB=1 SHAREDBUILD=1 test recurse
	@cd $(INSTALLHOME)/test/opt/shared/single/bin; ls > ../TestExes
	cd $(INSTALLHOME)/test/opt/shared/single && \
           PATH=$(INSTALLHOME)/test/opt/shared/single/bin:$(INSTALLHOME)/bin/utils/opt/shared/single/bin:$$PATH \
           LD_LIBRARY_PATH=$(INSTALLHOME)/lib/RAVL/$(ARC)/opt/shared/single:$$LD_LIBRARY_PATH \
           $(INSTALLHOME)/bin/utils/opt/bin/Validate -v $(INSTALLHOME)/test/opt/shared/single

.DEFAULT: qmake
	$(MAKE) $(PKG_MAKEFLAGS) $(CONFIG_MAKEFLAGS) -C $(SOURCEHOME) -f $(RAVL_MAKEFILE) $(RAVL_FLAGS) $@

#JFi:ToDo Targets for install-strip install-check uninstall clean 
#    dist distcheck html pdf install-html install-pdf installdirs distclean
#    mostlyclean maintainter-clean tags ctags


.PHONY: default check debug debugshared distdir doc fullsrc install opt optbin optshared qmake LocalQMake QMake retest retestsingleopt retestsingleoptshared rpm singleopt singleoptbin singleoptshared singleoptsharedbin singledebug singledebugbin singledebugshared singledebugsharedbin testopt testsingleopt testsingleoptshared .DEFAULT
