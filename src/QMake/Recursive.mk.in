# Start with WIP related bodges..

# Force these instead of proper implementation
ARC=linux64

# End of bodges



INSTALLHOME=@abs_top_builddir@

#OBJ_HOME=@abs_top_builddir@/$(LOGNAME)/qm/@abs_top_builddir@/$(ARC)
OBJ_HOME=@abs_top_builddir@/$(ARC)


include $(INSTALLHOME)/Config.Local

CCPPFLAGS+=-I$(INSTALLHOME)/include -DPROJECT_OUT=\"$(INSTALLHOME)\"
CPPFLAGS+=-I$(INSTALLHOME)/include -DPROJECT_OUT=\"$(INSTALLHOME)\"

CFLAGS=$(INCLUDES)
CXXFLAGS=$(INCLUDES)

include defs.mk

ifndef VAR
  VAR=opt
endif

ifeq ($(VAR),debug)
  CFLAGS += -g
  CXXFLAGS += -g
else
ifeq ($(VAR),opt)
    CFLAGS += -O2
    CXXFLAGS += -O2
else
ifeq ($(VAR),gprof)
      CFLAGS += -O2 -g -pg
      CXXFLAGS += -O2 -g -pg
endif
endif
endif

REQUIRED_DIRS=$(patsubst %.r,%, $(filter %.r,$(filter-out QMake.r,$(NESTED))))

# Some dirs specify programs as both examples and tests. In these circumstances
# we're better off stripping the tests from the example list so as to avoid
# any possible confusion over 'Test' depending on both $(EG-Bin-Dir)/Test and 
# $(Test-Bin-Dir)/Test
EGS=$(basename $(filter-out $(TESTEXES),$(EXAMPLES)))



# Declare what we link exes with
ifdef SINGLELIB
ifdef SHAREDBUILD
    BIN_SUBDIR=$(VAR)/shared/single
    DEPEND_ON=$(INSTALLHOME)/lib/RAVL/$(ARC)/$(VAR)/shared/single/libRavl.so
    LINK_WITH= -L$(INSTALLHOME)/lib/RAVL/$(ARC)/$(VAR)/shared/single -lRavl $(ALL_EXTERNAL_LIBS)
else
    BIN_SUBDIR=$(VAR)/single
    DEPEND_ON=$(INSTALLHOME)/lib/RAVL/$(ARC)/$(VAR)/single/libRavl.a
    #LINK_WITH=$(patsubst )%.cc,$(OBJ_HOME)/$(PLIB)/$(VAR)/objs/%.o,$(MUSTLINK)) -L$(INSTALLHOME)/lib/RAVL/$(ARC)/$(VAR)/single -lRavl $(ALL_EXTERNAL_LIBS)
    LINK_WITH= -Wl,--whole-archive -L$(INSTALLHOME)/lib/RAVL/$(ARC)/$(VAR)/single -lRavl -Wl,--no-whole-archive $(ALL_EXTERNAL_LIBS)
endif
else
# LINK_WITH= $(PLIB) $(USESLIBS) (+ $(PROGLIBS)???) processed for AUTO keyword (& optionally supplemented vi QLibs)     
$(error Standard builds not implemented yet - only SINGLELIB=1 currently supported)
endif

ifndef PACKAGE
PACKAGE=local
endif

ifeq ($(strip $(PLIB)),)
PLIB=$(PACKAGE)/None
NOLOCALLIB=$(addprefix $(OBJ_HOME)/$(PLIB)/$(VAR)/objs/,$(addsuffix .o,$(basename $(SOURCES))))
endif
# Some dirs build no library, only exes using SOURCES as additional objs.
# In these dirs, derive a list of '.o's from SOURCES and add them to the link 
# and additionally force a value on PLIB so the .o's have a directory

PROGS=$(basename $(MAINS))

TESTS=$(basename $(TESTEXES))

# Following definitions are used to block the cmd-line targets if RESOURCES
# or SUPPORT_ONLY/DONOT_SUPPORT are not set appropriately. If the settings
# are ok, these vars define what actual build target the cmd-line target
# relates to. If the settings are incorrect the variables cause a suitable
# error to be output instead of any build taking place. The 'recurse' target
# will quietly return if the settings indicate not to build
ifeq ($(strip $(filter-out $(RESOURCES),$(REQUIRES))),)
 # RESOURCES ok
ifeq ($(strip $(SUPPORT_ONLY)),)
  # No list of specificly supported platforms - test for unsupported platforms
ifneq ($(ARC), $(filter $(ARC),$(DONOT_SUPPORT)))
   # Not an unsupported platform
   $(foreach lib,$(filter %.def,$(EXTERNALLIBS)),$(eval include $(lib)))

   BUILD_ALL=buildlib buildprogs buildtests buildegs cpheaders mkdoc recurse
   BUILD_EGS=buildegs
   BUILD_LIB=buildlib
   BUILD_PROGS=buildprogs
   BUILD_TESTS=buildtests
   CP_HEADERS=cpheaders
   MK_DOC=mkdoc
   RECURSE=Yes
else
   BUILD_ALL=donotsupport
   BUILD_EGS=donotsupport
   BUILD_LIB=donotsupport
   BUILD_PROGS=donotsupport
   BUILD_TESTS=donotsupport
   CP_HEADERS=donotsupport
   MK_DOC=donotsupport
   RECURSE=No
endif
else
  # We have a specific list of supported platforms
ifeq ($(ARC),$(filter $(ARC),$(SUPPORT_ONLY)))
   # Platform is on the list of specifically supported platforms
   $(foreach lib,$(filter %.def,$(EXTERNALLIBS)),$(eval include $(lib)))

   BUILD_ALL=buildlib buildprogs buildtests buildegs cpheaders mkdoc recurse
   BUILD_EGS=buildegs
   BUILD_LIB=buildlib
   BUILD_PROGS=buildprogs
   BUILD_TESTS=buildtests
   CP_HEADERS=cpheaders
   MK_DOC=mkdoc
   RECURSE=Yes
else
   # Not on the list of specifically supported platforms
   BUILD_ALL=notsupportonly
   BUILD_EGS=notsupportonly
   BUILD_LIB=notsupportonly
   BUILD_PROGS=notsupportonly
   BUILD_TESTS=notsupportonly
   CP_HEADERS=notsupportonly
   MK_DOC=notsupportonly
   RECURSE=No
endif
endif
else
 # RESOURCES not available
   BUILD_ALL=noresources
   BUILD_EGS=noresources
   BUILD_LIB=noresources
   BUILD_PROGS=noresources
   BUILD_TESTS=noresources
   CP_HEADERS=noresources
   MK_DOC=noresources
   RECURSE=No
endif

# cmdline targets
all: $(BUILD_ALL)

docn: $(MK_DOC)

examples: $(BUILD_EGS)

headers: $(CP_HEADERS)

library: $(BUILD_LIB)

programs: $(BUILD_PROGS)

recurse:
	@if [ $(RECURSE) = Yes ] ;then for d in $(REQUIRED_DIRS);do $(MAKE) -I$(INSTALLHOME)/lib/RAVL/libdep/ -C $$d -f $(INSTALLHOME)/share/RAVL/QMake/Recursive.mk $(MAKECMDGOALS); RET=$$?; if [ $$RET -ne 0 ] ;then exit $$RET; fi; done; fi

test: $(BUILD_TESTS)
# Initial set-up not yet implemented - use QMake first

# internal targets
# first group perform the action associated with the relevant cmd-line targets

buildegs: $(EGS)

buildlib:
	: Not implemented

buildprogs: $(PROGS)

buildtests: $(TESTS)

cpheaders: $(HEADERS)
	: Not implememted

donotsupport:
	@echo Platform is not supported for this directory tree

mkdoc:
	: Not implememted

noresources:
	@echo Insufficient RESOURCES for this directory tree

notsupportonly:
	@echo Platform not on the SUPPORT_ONLY list for this directory tree



# Declare recipies to build utilities from single src file and lib
define buildutils
  $1: $(INSTALLHOME)/bin/utils/$(BIN_SUBDIR) $(INSTALLHOME)/bin/utils/$(BIN_SUBDIR)/$1

  $(INSTALLHOME)/bin/utils/$(BIN_SUBDIR)/$1: $(OBJ_HOME)/$(PLIB)/$(VAR)/objs/$1.o $2
	$(CXX) $(CFLAGS) $(OBJ_HOME)/$(PLIB)/$(VAR)/objs/$1.o $3 -o $$@
endef

$(INSTALLHOME)/bin/utils/$(BIN_SUBDIR):
	@@MKDIR_P@ $@

$(foreach bin,$(PROGS),$(eval $(call buildutils,$(bin),$(NOLOCALLIB) $(DEPEND_ON),$(NOLOCALLIB) $(LINK_WITH))))


# Declare recipies to build examples from single src file and lib
define buildexamples
  $1: $(INSTALLHOME)/bin/examples/$(BIN_SUBDIR) $(INSTALLHOME)/bin/utils/$(BIN_SUBDIR)/$1

  $(INSTALLHOME)/bin/examples/$(BIN_SUBDIR)/$1: $(OBJ_HOME)/$(PLIB)/$(VAR)/objs/$1.o $2
	$(CXX) $(CFLAGS) $(OBJ_HOME)/$(PLIB)/$(VAR)/objs/$1.o $3 -o $$@
endef

$(INSTALLHOME)/bin/examples/$(BIN_SUBDIR):
	@@MKDIR_P@ $@

$(foreach bin,$(EGS),$(eval $(call buildexamples,$(bin),$(NOLOCALLIB) $(DEPEND_ON),$(NOLOCALLIB) $(LINK_WITH))))


# Declare recipies to build test binaries from single src file and lib
define buildtest
  $1: $(INSTALLHOME)/share/RAVL/Admin/$(ARC)/test/$(BIN_SUBDIR)/bin \
           $(INSTALLHOME)/share/RAVL/Admin/$(ARC)/test/$(BIN_SUBDIR)/log \
                $(INSTALLHOME)/share/RAVL/Admin/$(ARC)/test/$(BIN_SUBDIR)/bin/$1

  $(INSTALLHOME)/share/RAVL/Admin/$(ARC)/test/$(BIN_SUBDIR)/bin/$1: $(OBJ_HOME)/$(PLIB)/$(VAR)/objs/$1.o $2
	$(CXX) $(CFLAGS) $(OBJ_HOME)/$(PLIB)/$(VAR)/objs/$1.o $3 -o $$@
endef

$(INSTALLHOME)/share/RAVL/Admin/$(ARC)/test/$(BIN_SUBDIR)/bin:
	@@MKDIR_P@ $@

$(INSTALLHOME)/share/RAVL/Admin/$(ARC)/test/$(BIN_SUBDIR)/log:
	@@MKDIR_P@ $@

$(foreach bin,$(TESTS),$(eval $(call buildtest,$(bin),$(NOLOCALLIB) $(TESTLIBS) $(DEPEND_ON),$(NOLOCALLIB) $(TESTLIBS) $(LINK_WITH))))



# Provide info that may be helpful for debugging
dump:
	@echo BIN_SUBDIR=$(BIN_SUBDIR)
	@echo DIRS=$(DIRS)
	@echo DEPEND_ON=$(DEPEND_ON)
	@echo EGS=$(EGS)
	@echo LINK_WITH=$(LINK_WITH)
	@echo NOLOCALLIB=$(NOLOCALLIB)
	@echo PLIB=$(PLIB)
	@echo PROGS=$(PROGS)
	@echo REQUIRED_DIRS=$(REQUIRED_DIRS)
	@echo TESTS=$(TESTS)
	@echo TESTLIBS=$(TESTLIBS)

.PHONY: all buildegs $(EGS) buildlib  buildprogs $(PROGS) buildtests $(TESTS) cpheaders docn donotsupport dump examples headers library mkdoc noresources notsupportonly programs recurse test
